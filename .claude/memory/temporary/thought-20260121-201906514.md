---
type: breadcrumb
title: "Think: Evaluating update handling strategy for session summaries PreCompact hook"
topic: Evaluating update handling strategy for session summaries PreCompact hook
status: concluded
created: "2026-01-21T20:19:06.523Z"
updated: "2026-01-21T20:19:58.978Z"
tags:
  - think
  - concluded
scope: project
conclusion: "Recommended approach: 1) Use meta file with proper-lockfile for safe concurrent access. 2) PreCompact: Quick extraction with streaming parser, write new segment, update meta atomically. 3) Command: Read all segments + optional fresh parse. 4) Fallback: Glob search for transcript when path empty. 5) Library: jsonl-parse for TypeScript streaming"
promotedTo: decision-evaluating-update-handling-strategy-for-session-su
---

# Evaluating update handling strategy for session summaries PreCompact hook

_Thinking document created 2026-01-21T20:19:06.523Z_

## Thoughts

### 2026-01-21T20:19:20.061Z - Thought
Meta file approach: .claude/summaries/{session_id}.meta.json with lastLineExtracted. Pros: Simple checkpoint tracking, handles multiple compactions. Cons: Additional file I/O, potential race conditions on concurrent reads

### 2026-01-21T20:19:21.767Z - Alternative
Alternative: Embed checkpoint in segment files themselves. Each segment tracks its own line range. Pros: Self-contained segments, no separate meta file. Cons: Must read all segments to determine next checkpoint

### 2026-01-21T20:19:23.961Z - Thought
Transcript path fallback needed due to bug #13668. Can derive from session_id: ~/.claude/projects/{slug}/{session_id}.jsonl. But need to determine project slug - may require searching ~/.claude/projects/*/{session_id}.jsonl

### 2026-01-21T20:19:36.402Z - Thought
Streaming vs full load: For large transcripts (>100MB), streaming parser (jsonl-parse or stream-json) is essential. PreCompact hook must be fast (<5s) to avoid blocking. Command retrieval can use full load for smaller sessions, streaming for large ones

### 2026-01-21T20:19:38.266Z - Thought
Edge cases: 1) Empty sessions - skip extraction. 2) Very large transcripts - need timeout, progress tracking. 3) Concurrent access - proper-lockfile library for file locking. 4) Corrupted JSONL - need error recovery, skip malformed lines

### 2026-01-21T20:19:40.155Z - Counter-argument
Meta file approach has race condition risk. If PreCompact fires during command execution, both could read/write meta file simultaneously. Need file locking or atomic writes

### 2026-01-21T20:19:58.977Z - Conclusion
Recommended approach: 1) Use meta file with proper-lockfile for safe concurrent access. 2) PreCompact: Quick extraction with streaming parser, write new segment, update meta atomically. 3) Command: Read all segments + optional fresh parse. 4) Fallback: Glob search for transcript when path empty. 5) Library: jsonl-parse for TypeScript streaming
